<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <script type="text/javascript" src="prefkeys.js"></script>
  
  <title>Weave Account Settings</title>
<script type="application/x-javascript">
Components.utils.import("resource://weave/service.js");

function changePassword() {
  // TODO implement this
}

function changeClientName() {
  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
     .getService(Components.interfaces.nsIPrefBranch);
  var clientName = document.getElementById("client-name").value;
  prefService.setCharPref("extensions.weave.client.name");
}

function updateCheckBoxes() {
  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
     .getService(Components.interfaces.nsIPrefBranch);
  var checked;
  checked = document.getElementById("bookmarks-check").checked;
  prefService.setBoolPref("extensions.weave.engine.bookmarks", checked);
  
  checked = document.getElementById("cookies-check").checked;
  prefService.setBoolPref("extensions.weave.engine.cookies", checked);

  checked = document.getElementById("history-check").checked;
  prefService.setBoolPref("extensions.weave.engine.history", checked);

  checked = document.getElementById("tabs-check").checked;
  prefService.setBoolPref("extensions.weave.engine.tabs", checked);

  checked = document.getElementById("passwords-check").checked;
  prefService.setBoolPref("extensions.weave.engine.passwords", checked);

  checked = document.getElementById("forms-check").checked;
  prefService.setBoolPref("extensions.weave.engine.forms", checked);
}

function onLoad() {
  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
     .getService(Components.interfaces.nsIPrefBranch);
  var serverUrl = prefService.getCharPref("extensions.weave.serverURL");
  var username = prefService.getCharPref("extensions.weave.username");
  //var clientName = prefService.getCharPref("extensions.weave.client.name");
  document.getElementById("username").innerHTML = username;
  document.getElementById("server-url").innerHTML = serverUrl;
  //document.getElementById("client-name").value = clientName;

  var checked;
  checked = prefService.getBoolPref("extensions.weave.engine.bookmarks");
  document.getElementById("bookmarks-check").checked = checked;
  checked = prefService.getBoolPref("extensions.weave.engine.cookies");
  document.getElementById("cookies-check").checked = checked;
  checked = prefService.getBoolPref("extensions.weave.engine.history");
  document.getElementById("history-check").checked = checked;
  checked = prefService.getBoolPref("extensions.weave.engine.tabs");
  document.getElementById("tabs-check").checked = checked;
  checked = prefService.getBoolPref("extensions.weave.engine.passwords");
  document.getElementById("passwords-check").checked = checked;
  checked = prefService.getBoolPref("extensions.weave.engine.forms");
  document.getElementById("forms-check").checked = checked;
}

function syncNowButton() {
    /* Makes a sync happen immediately.
       Just for dev/debug; probably not an exposed UI feature in the finished
       version. */

    // As I expected, it's not logged in. Probably because of the wbo.js thing?
    if (!Weave.Service.isLoggedIn) {
      dump("Can't sync, weave service not logged in.\n");
      Weave.Service.login( function() {
                          dump("Login Complete.  Calling sync...\n");
                          Weave.Service.sync();
                          dump("Called sync.\n");
                          },
			 Weave.Service.username,
			 Weave.Service.password,
			 Weave.Service.passphrase);
      return;
    }
    if (Weave.Service.isQuitting) {
      dump("Can't sync, I'm quitting.\n");
      return;
    }
    dump("Calling sync...\n");
    Weave.Service.sync();
    dump("Called sync.\n");

    // If we need debugging help with this, set up observers:
    // (from status.js)
    /*     this._os.addObserver(this, "weave:service:sync:start", true);
    this._os.addObserver(this, "weave:service:sync:engine:start", true);
    this._os.addObserver(this, "weave:service:sync:status", true);
    this._os.addObserver(this, "weave:service:sync:success", true);
    this._os.addObserver(this, "weave:service:sync:error", true);

    this._os.addObserver(this, "weave:service:global:success", true);
    this._os.addObserver(this, "weave:service:global:error", true);
   */

}

window.addEventListener("load", onLoad, false);

</script>

</head>

<body style="font-size:1.5em">

<!-- This is the Weave Prefs screen, accessible at
chrome://weave/content/fennec-prefs.html.-->
 <h2>Weave Account Settings</h2>
 <form>
    <input type="button" value="Sync Now" onclick="syncNowButton();"/>
    <table style="font-size:1em">
    <tr><td>
    <fieldset>
      <legend>Synchronize These Data Types:</legend>
      <table style="font-size:1em">
       <tr><td>Bookmarks</td><td><input type="checkbox"
	 id="bookmarks-check" onclick="updateCheckBoxes();"/></td></tr>
       <tr><td>Cookies</td><td><input type="checkbox"
	 id="cookies-check" onclick="updateCheckBoxes();"/></td></tr>
       <tr><td>Browsing History</td><td><input type="checkbox"
	 id="history-check" onclick="updateCheckBoxes();"/></td></tr>
       <tr><td>Tabs</td><td><input type="checkbox"
	 id="tabs-check" onclick="updateCheckBoxes();"/></td></tr>
       <tr><td>Passwords</td><td><input type="checkbox"
	 id="passwords-check" onclick="updateCheckBoxes();"/></td></tr>
       <tr><td>Saved Form Data</td><td><input type="checkbox"
	 id="forms-check" onclick="updateCheckBoxes();"/></td></tr>
      </table>
    </fieldset>
    </td><td>
    <fieldset>
      <legend>Change your Client Name:</legend>
      Client name: <input type="text" value="FennecPhone" id="client-name"/>
      <input type="button" value="Change" onclick="changeClientName();"/>
    </fieldset>
    <fieldset>
      <legend>Change your Password:</legend>
      <table>
	<tr><td>Enter Old Password:</td>
	<td><input type="text" id="old-password-input"/></td></tr>
	<tr><td>Enter New Password:</td>
	<td><input type="text" id="new-password-input"/></td></tr>
	<tr><td colspan="2">
	  <input type="button" value="Change" onclick="changePassword();"/>
	</td></tr>
      </table>
    </fieldset>
    </td></tr></table>

    <fieldset>
      <legend>Reset Lost Password:</legend>
      <p>Lost your password?  <a href="">Have an email sent to you</a> containing instructions for resetting your password.</p>

    </fieldset>
    <fieldset>
      <legend>Use A Different Account or Server:</legend>
      <p>You are currently logged in to Weave
         as user <strong><span id="username"></span></strong>
         on server <strong><span id="server-url"></span></strong>.
      <a href="fennec-connect.html">Use a different account or server</a>.  (You will be asked to re-enter your password and passphrase.)</p>

    </fieldset>
 </form>


</body> </html>
