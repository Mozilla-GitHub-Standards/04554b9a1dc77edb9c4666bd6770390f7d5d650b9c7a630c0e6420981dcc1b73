<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>Weave: Setup This Device With Existing Account</title>
<script type="application/x-javascript">
Components.utils.import("resource://weave/service.js");

var gPasswordHidden = false;

function doSaveSettings() {
  var usernameInput = document.getElementById("username-input").value;
  var passwordInput = document.getElementById("password-input").value;
  var passphraseInput = document.getElementById("passphrase-input").value;
  //var serverUrlInput = document.getElementById("server-url-input").value;

  //var clientName = document.getElementById("client-name-input").value;

  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
    .getService(Components.interfaces.nsIPrefBranch);
  //prefService.setCharPref("extensions.weave.serverURL", serverUrlInput);
  prefService.setCharPref("extensions.weave.username", usernameInput);
  //prefService.setCharPref("extensions.weave.client.name", clientName);
  Weave.Service.password = passwordInput;
  Weave.Service.passphrase = passphraseInput;
}

function onLoad() {
  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
     .getService(Components.interfaces.nsIPrefBranch);
  //var serverUrl = prefService.getCharPref("extensions.weave.serverURL");
  var username = prefService.getCharPref("extensions.weave.username");
  //var clientName = prefService.getCharPref("extensions.weave.client.name");
  if (username && username != "nobody")
    document.getElementById("username-input").value = username;
  else
    document.getElementById("username-input").value = "Your Username Here";
  //document.getElementById("server-url-input").value = serverUrl;
  //document.getElementById("client-name-input").value = clientName;
  if (Weave.Service.passphrase)
    document.getElementById("passphrase-input").value = Weave.Service.passphrase;
  else
    document.getElementById("passphrase-input").value = "Your Passphrase Here";
  if (Weave.Service.password)
    document.getElementById("password-input").value = Weave.Service.password;
  else
    document.getElementById("password-input").value = "Your Password Here";
}

function submit() {
  // Signup to Weave, then redirect to prefs page.
  //gFennecWeaveGlue.onSignupComplete();

  var err = document.getElementById("err-msg");
  err.innerHTML = "Logging you in...";
  if (Weave.Service.isLoggedIn)
    Weave.Service.logout();

  doSaveSettings();

  Weave.Service.login( function(success) {
                         err.innerHTML = "Login success result is " + success;
                         /*if (success) {
                           err.innerHTML = "Login Succeeded!";
                           location.href = "fennec-prefs.html";
                         } else {
                           err.innerHTML = "Login Failed!!!";
                         }*/
                       });
}

function doHide() {
  // TODO store hiddenness of password in a preference so it's
  // persistent across reloads of this page.
  gPasswordHidden = !gPasswordHidden;
  //var passwordHidden = document.getElementById("hide-password").checked;

  var passwordField = document.getElementById("password-input");
  var passphraseField = document.getElementById("passphrase-input");
  var lockIcon = document.getElementById("hide-password");
  if (gPasswordHidden) {
    passwordField.type="password";
    passphraseField.type="password";
    lockIcon.src="chrome://weave/skin/lock-closed.png";
  } else {
    passwordField.type="text";
    passphraseField.type="text";
    lockIcon.src="chrome://weave/skin/lock-open.png";
  }
}

function selectField(id) {
  var field = document.getElementById(id);
  field.focus();
  field.select();
}

window.addEventListener("load", onLoad, false);

</script>
<style type="text/css">
  input.embiggened {width: 100%; text-align: left; font-size:24pt}
  #password-input {width:90%;}
  p {font-size: 12pt; text-align: center;}
  h1 {font-size: 24pt; text-align: center;}
  #err-msg {color: red; font-weight: bold}
  p.left {text-align: left}

  #lower-left {width: 60%; float: left; text-align: left;}
  #lower-right {width: 40%; float: right; font-size:18pt; margin-top: 10px}

  big-button {width: 400px; height: 100px; font-size: 24pt}
</style>
</head>
<body>
 <p id="err-msg"></p>
 <p>If you have a Weave account, enter your info below to connect to
     it with this device.</p>
<input type="text" class="embiggened" id="username-input"
        onclick="selectField('username-input')"/><br/><br/>
<input type="text" class="embiggened" id="password-input"
        onclick="selectField('password-input')"/>
<img width="32" height="32" src="chrome://weave/skin/lock-open.png" id="hide-password" onclick="doHide();"/><br/><br/>
<input type="text" class="embiggened" size="120" id="passphrase-input"
        onclick="selectField('passphrase-input')"/>

<div id="bounding-box">
<div id="lower-left">
   <p class="left">Please <a href="">Read the Weave Terms of Service</a>.<br/>
   By clicking the box at right, you agree to these terms.</p>
</div>

<div id="lower-right">
  <input type="button" value="Connect" onclick="submit();"
          class="big-button"/>
</div>
</body> </html>
